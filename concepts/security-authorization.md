---
title: 授权和 Microsoft Graph 安全性 API
description: 可通过 Microsoft Graph 安全性 API 访问的安全数据是很敏感的，它受到权限和 Azure Active Directory (Azure AD) 角色保护。
author: preetikr
localization_priority: Priority
ms.prod: security
ms.openlocfilehash: 2814bf52b575176c95d6ae69f46008e7a56a4cd1
ms.sourcegitcommit: 3fbc2249b307e8d3a9de18f22ef6911094ca272c
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 09/26/2020
ms.locfileid: "48288166"
---
# <a name="authorization-and-the-microsoft-graph-security-api"></a><span data-ttu-id="adbd6-103">授权和 Microsoft Graph 安全性 API</span><span class="sxs-lookup"><span data-stu-id="adbd6-103">Authorization and the Microsoft Graph Security API</span></span>

<span data-ttu-id="adbd6-104">可通过 Microsoft Graph 安全性 API 访问的安全数据是很敏感的，它受到权限和 Azure Active Directory (Azure AD) 角色保护。</span><span class="sxs-lookup"><span data-stu-id="adbd6-104">Security data accessible via the Microsoft Graph Security API is sensitive and protected by both permissions and Azure Active Directory (Azure AD) roles.</span></span>

<span data-ttu-id="adbd6-105">Microsoft Graph 安全性 API 支持以下两种类型的授权：</span><span class="sxs-lookup"><span data-stu-id="adbd6-105">The Microsoft Graph Security API supports two types of authorization:</span></span>

- <span data-ttu-id="adbd6-106">**应用级授权** - 没有已登录用户（例如，SIEM 方案）。</span><span class="sxs-lookup"><span data-stu-id="adbd6-106">**Application-level authorization** - There is no signed-in user (for example, a SIEM scenario).</span></span> <span data-ttu-id="adbd6-107">授权由授予给应用程序的权限决定。</span><span class="sxs-lookup"><span data-stu-id="adbd6-107">The permissions granted to the application determine authorization.</span></span> 
    ><span data-ttu-id="adbd6-108">**注意：** 此选项还可以支持基于角色的访问控制 (RBAC) 由应用程序管理的情况。</span><span class="sxs-lookup"><span data-stu-id="adbd6-108">**Note:** This option can also support cases where Role-Based Access Control (RBAC) is managed by the application.</span></span>
- <span data-ttu-id="adbd6-109">**用户委派授权** - 身份为 Azure AD 租户成员的用户已登录。</span><span class="sxs-lookup"><span data-stu-id="adbd6-109">**User delegated authorization** - A user who is a member of the Azure AD tenant is signed in.</span></span> <span data-ttu-id="adbd6-110">除了已被授予所需权限的应用程序之外，用户必须是 Azure AD 有限管理员角色的成员 - 安全读者或安全管理员。</span><span class="sxs-lookup"><span data-stu-id="adbd6-110">The user must be a member of an Azure AD Limited Admin role - either Security Reader or Security Administrator - in addition to the application having been granted the required permissions.</span></span>

<span data-ttu-id="adbd6-111">若要从 Graph 浏览器调用 Microsoft Graph 安全性 API：</span><span class="sxs-lookup"><span data-stu-id="adbd6-111">If you're calling the Microsoft Graph Security API from Graph Explorer:</span></span>

- <span data-ttu-id="adbd6-112">Azure AD 租户管理员必须对 Graph 浏览器应用显式授予所请求的权限。</span><span class="sxs-lookup"><span data-stu-id="adbd6-112">The Azure AD tenant admin must explicitly grant consent for the requested permissions to the Graph Explorer application.</span></span>
- <span data-ttu-id="adbd6-113">用户必须是 Azure AD 中安全读者有限管理员角色的成员（安全读者或安全管理员）。</span><span class="sxs-lookup"><span data-stu-id="adbd6-113">The user must be a member of the Security Reader Limited Admin role in Azure AD (either Security Reader or Security Administrator).</span></span>

><span data-ttu-id="adbd6-114">**注意**：Graph 浏览器不支持应用级授权。</span><span class="sxs-lookup"><span data-stu-id="adbd6-114">**Note**: Graph Explorer does not support application-level authorization.</span></span>

<span data-ttu-id="adbd6-115">若要从自定义应用或你自己的应用调用 Microsoft Graph 安全性 API：</span><span class="sxs-lookup"><span data-stu-id="adbd6-115">If you're calling the Microsoft Graph Security API from a custom or your own application:</span></span>

- <span data-ttu-id="adbd6-116">Azure AD 租户管理员必须对你的应用显式授权。</span><span class="sxs-lookup"><span data-stu-id="adbd6-116">The Azure AD tenant admin must explicitly grant consent to your application.</span></span> <span data-ttu-id="adbd6-117">这对于应用程序级别授权和用户委派授权都是必需的。</span><span class="sxs-lookup"><span data-stu-id="adbd6-117">This is required both for application-level authorization and user delegated authorization.</span></span>
- <span data-ttu-id="adbd6-118">如果正在使用用户委派授权，用户必须是 Azure AD 中安全读者或安全管理员有限管理员角色的成员。</span><span class="sxs-lookup"><span data-stu-id="adbd6-118">If you're using user delegated authorization, the user must be a member of the Security Reader or Security Administrator Limited Admin role in Azure AD.</span></span>

## <a name="manage-authorization-in-security-api-client-applications"></a><span data-ttu-id="adbd6-119">管理安全性 API 客户端应用中的授权</span><span class="sxs-lookup"><span data-stu-id="adbd6-119">Manage authorization in security API client applications</span></span>

<span data-ttu-id="adbd6-120">通过 Microsoft Graph 安全性 API 提供的安全数据是很敏感的，必须受到适当身份验证和授权机制的保护。</span><span class="sxs-lookup"><span data-stu-id="adbd6-120">Security data provided via the Microsoft Graph Security API is sensitive and must be protected by appropriate authentication and authorization mechanisms.</span></span> <span data-ttu-id="adbd6-121">下表列出了注册和创建可访问 Microsoft Graph 安全性 API 的客户端应用的步骤。</span><span class="sxs-lookup"><span data-stu-id="adbd6-121">The following table lists the steps to register and create a client application that can access the Microsoft Graph Security API.</span></span>

| <span data-ttu-id="adbd6-122">**谁**</span><span class="sxs-lookup"><span data-stu-id="adbd6-122">**Who**</span></span> | <span data-ttu-id="adbd6-123">**操作**</span><span class="sxs-lookup"><span data-stu-id="adbd6-123">**Action**</span></span> |
|:---------------------|:------------------|
|<span data-ttu-id="adbd6-124">应用程序开发人员或所有者：</span><span class="sxs-lookup"><span data-stu-id="adbd6-124">Application developer or owner</span></span>|<span data-ttu-id="adbd6-125">将应用程序注册为企业应用程序。</span><span class="sxs-lookup"><span data-stu-id="adbd6-125">Register the application as an enterprise application.</span></span>|
|<span data-ttu-id="adbd6-126">租户管理员</span><span class="sxs-lookup"><span data-stu-id="adbd6-126">Tenant admin</span></span>|<span data-ttu-id="adbd6-127">向应用程序授予权限。</span><span class="sxs-lookup"><span data-stu-id="adbd6-127">Grant permissions to the application.</span></span>|
|<span data-ttu-id="adbd6-128">租户管理员</span><span class="sxs-lookup"><span data-stu-id="adbd6-128">Tenant admin</span></span>|<span data-ttu-id="adbd6-129">为用户分配角色。</span><span class="sxs-lookup"><span data-stu-id="adbd6-129">Assign roles to users.</span></span>|
|<span data-ttu-id="adbd6-130">应用开发人员</span><span class="sxs-lookup"><span data-stu-id="adbd6-130">Application developer</span></span>|<span data-ttu-id="adbd6-131">以用户身份登录，并使用应用访问 Microsoft Graph 安全性 API。</span><span class="sxs-lookup"><span data-stu-id="adbd6-131">Sign in as the user and use the application to access the Microsoft Graph Security API.</span></span>|

<span data-ttu-id="adbd6-132">应用注册仅定义运行应用所需的权限。</span><span class="sxs-lookup"><span data-stu-id="adbd6-132">Application registration only defines which permissions the application needs in order to run.</span></span> <span data-ttu-id="adbd6-133">它不对应用程序进行这些权限的授予。</span><span class="sxs-lookup"><span data-stu-id="adbd6-133">It does NOT grant these permissions to the application.</span></span>

<span data-ttu-id="adbd6-134">Azure AD 租户管理员必须对应用程序显式授予权限。</span><span class="sxs-lookup"><span data-stu-id="adbd6-134">The Azure AD tenant administrator MUST explicitly grant the permissions to the application.</span></span> <span data-ttu-id="adbd6-135">这必须按每租户实施，并且必须在应用程序权限在应用程序注册门户中*每次更改时执行*。</span><span class="sxs-lookup"><span data-stu-id="adbd6-135">This must be done per tenant and must be *performed every time* the application permissions are changed in the application registration portal.</span></span>

<span data-ttu-id="adbd6-136">例如，假定你拥有一个应用程序、两个 Azure AD 租户（**T1** 和 **T2**），以及两个权限（**P1** 和 **P2**）。</span><span class="sxs-lookup"><span data-stu-id="adbd6-136">For example, assume that you have an application, two Azure AD tenants, **T1** and **T2**, and two permissions, **P1** and **P2**.</span></span> <span data-ttu-id="adbd6-137">以下是授权过程：</span><span class="sxs-lookup"><span data-stu-id="adbd6-137">The following is the authorization process:</span></span>

- <span data-ttu-id="adbd6-138">应用程序注册以请求权限 **P1**。</span><span class="sxs-lookup"><span data-stu-id="adbd6-138">The application registers to require permission **P1**.</span></span>
- <span data-ttu-id="adbd6-139">当租户 **T1** 中的用户获取此应用程序的 Azure AD 令牌时，该令牌不包含任何权限。</span><span class="sxs-lookup"><span data-stu-id="adbd6-139">When users in tenant **T1** get an Azure AD token for this application, the token does not contain any permissions.</span></span>
- <span data-ttu-id="adbd6-140">租户 **T1** 的 Azure AD 管理员向应用程序显式授予权限。</span><span class="sxs-lookup"><span data-stu-id="adbd6-140">The Azure AD admin of tenant **T1** explicitly grants permissions to the application.</span></span> <span data-ttu-id="adbd6-141">当租户 **T1** 中的用户获取应用程序的 Azure AD 令牌时，它将包含权限 **P1**。</span><span class="sxs-lookup"><span data-stu-id="adbd6-141">When users in tenant **T1** get an Azure AD token for the application, it will contain permission **P1**.</span></span>
- <span data-ttu-id="adbd6-142">当租户 **T2** 中的用户获取应用程序的 Azure AD 令牌时，该令牌不包含任何权限，因为租户 **T2** 的管理员尚未向该应用程序授予权限。</span><span class="sxs-lookup"><span data-stu-id="adbd6-142">When users in tenant **T2** get an Azure AD token for the application, the token does not contain any permissions - because the admin of tenant **T2** did not yet grant permissions to the application.</span></span> <span data-ttu-id="adbd6-143">权限必须按照*每个租户*和*每个应用程序*进行授予。</span><span class="sxs-lookup"><span data-stu-id="adbd6-143">Permission must be granted *per tenant* and *per application*.</span></span>
- <span data-ttu-id="adbd6-144">应用程序将其注册更改为现在需要权限 **P1** 和 **P2**。</span><span class="sxs-lookup"><span data-stu-id="adbd6-144">The application has its registration changed to now require permissions **P1** and **P2**.</span></span>
- <span data-ttu-id="adbd6-145">当租户 **T1** 中的用户获取应用程序的 Azure AD 令牌时，它仅包含权限 **P1**。</span><span class="sxs-lookup"><span data-stu-id="adbd6-145">When users in tenant **T1** get an Azure AD token for the application, it only contains permission **P1**.</span></span> <span data-ttu-id="adbd6-146">授予应用程序的权限作为授予内容快照进行记录，它们在应用程序注册（权限）更改后*不会自动更改*。</span><span class="sxs-lookup"><span data-stu-id="adbd6-146">Permissions granted to an application are recorded as snapshots of what was granted - they *do not change automatically* after the application registration (permission) changes.</span></span>
- <span data-ttu-id="adbd6-147">租户 **T2** 的管理员对应用程序授予权限 **P1** 和 **P2**。</span><span class="sxs-lookup"><span data-stu-id="adbd6-147">The admin of tenant **T2** grants permissions **P1** and **P2** to the application.</span></span> <span data-ttu-id="adbd6-148">当租户 **T2** 中的用户获取应用程序的 Azure AD 令牌时，该令牌将包含权限 **P1** 和 **P2**。</span><span class="sxs-lookup"><span data-stu-id="adbd6-148">Now, when users in tenant **T2** get an Azure AD token for the application, the token will contain permissions **P1** and **P2**.</span></span>

><span data-ttu-id="adbd6-149">**注意**：租户 **T1** 中的应用程序和租户 **T2** 中的应用程序的 Azure AD 令牌包含不同权限，因为每个租户管理员已为应用程序授予不同的权限。</span><span class="sxs-lookup"><span data-stu-id="adbd6-149">**Note**: The Azure AD tokens for the application in tenant **T1** and the application in tenant **T2** contain different permissions, because each tenant admin has granted different permissions to the application.</span></span>

- <span data-ttu-id="adbd6-150">如需使租户 **T1** 中的应用程序再次运行，租户 **T1** 的管理员必须向应用程序显式授予权限 **P1** 和 **P2**。</span><span class="sxs-lookup"><span data-stu-id="adbd6-150">To make the application work again in tenant **T1**, the admin of tenant **T1** must explicitly grant permissions **P1** and **P2** to the application.</span></span>

## <a name="register-an-application-with-the-microsoft-identity-platform-endpoint"></a><span data-ttu-id="adbd6-151">向 Microsoft 标识平台终结点注册应用程序</span><span class="sxs-lookup"><span data-stu-id="adbd6-151">Register an application with the Microsoft identity platform endpoint</span></span>

<span data-ttu-id="adbd6-152">若要向 Microsoft 标识平台终结点注册应用程序，你需要：</span><span class="sxs-lookup"><span data-stu-id="adbd6-152">To register an application to the Microsoft identity platform endpoint, you'll need:</span></span>

- <span data-ttu-id="adbd6-153">**应用程序名称** - 表示应用程序名称的字符串。</span><span class="sxs-lookup"><span data-stu-id="adbd6-153">**Application name** - A string used for the application name.</span></span>
- <span data-ttu-id="adbd6-154">**重定向 URL** - 该 URL 发送来自 Azure AD 的身份验证响应。</span><span class="sxs-lookup"><span data-stu-id="adbd6-154">**Redirect URL** - The URL where the authentication response from Azure AD is sent.</span></span> <span data-ttu-id="adbd6-155">请使用测试客户端 web 应用主页以开始。</span><span class="sxs-lookup"><span data-stu-id="adbd6-155">To start, you can use the test client web app homepage.</span></span>
- <span data-ttu-id="adbd6-156">**所需的权限** - 应用程序需要的用于调用 Microsoft Graph 的权限。</span><span class="sxs-lookup"><span data-stu-id="adbd6-156">**Required Permissions** - The permissions that your application requires to be able to call Microsoft Graph.</span></span>

<span data-ttu-id="adbd6-157">注册应用程序：</span><span class="sxs-lookup"><span data-stu-id="adbd6-157">To register your application:</span></span>

1. <span data-ttu-id="adbd6-158">转到 [Azure 应用注册门户](https://go.microsoft.com/fwlink/?linkid=2083908)并登录。</span><span class="sxs-lookup"><span data-stu-id="adbd6-158">Go to the [Azure app registration portal](https://go.microsoft.com/fwlink/?linkid=2083908) and sign in.</span></span>
    ><span data-ttu-id="adbd6-159">**注意**：你无需是租户管理员。你将被重定向到“**我的应用程序**”列表。</span><span class="sxs-lookup"><span data-stu-id="adbd6-159">**Note**: You don't have to be a tenant admin. You will be redirected to the **My applications** list.</span></span>
2. <span data-ttu-id="adbd6-160">选择“**新注册**”。</span><span class="sxs-lookup"><span data-stu-id="adbd6-160">Choose **New registration**.</span></span>
3. <span data-ttu-id="adbd6-161">在新应用程序的注册页面上，输入“**名称**”的值，然后选择希望支持的帐户类型。</span><span class="sxs-lookup"><span data-stu-id="adbd6-161">On the registration page for the new application, enter a value for **Name** and select the account types you wish to support.</span></span> <span data-ttu-id="adbd6-162">在“**重定向 URI**”字段中，输入重定向 URL。</span><span class="sxs-lookup"><span data-stu-id="adbd6-162">In the **Redirect URI** field, enter the redirect URL.</span></span>
4. <span data-ttu-id="adbd6-163">选择“**注册**”以创建应用并查看其概述页面。</span><span class="sxs-lookup"><span data-stu-id="adbd6-163">Select **Register** to create the app and view its overview page.</span></span> *
5. <span data-ttu-id="adbd6-164">转到应用的“**API 权限**”页面。</span><span class="sxs-lookup"><span data-stu-id="adbd6-164">Go to the app's **API permissions** page.</span></span>
6. <span data-ttu-id="adbd6-165">选择“**添加权限**”，然后在浮出控件中选择“**Microsoft Graph**”。</span><span class="sxs-lookup"><span data-stu-id="adbd6-165">Select **Add a permission** and then choose **Microsoft Graph** in the flyout.</span></span> <span data-ttu-id="adbd6-166">选择“**委托的权限**”。</span><span class="sxs-lookup"><span data-stu-id="adbd6-166">Select **Delegated permissions**.</span></span> <span data-ttu-id="adbd6-167">使用搜索框查找并选择所需的权限。</span><span class="sxs-lookup"><span data-stu-id="adbd6-167">Use the search box to find and select the required permissions.</span></span> <span data-ttu-id="adbd6-168">如需查看权限列表，请参阅[安全权限](permissions-reference.md#security-permissions)。</span><span class="sxs-lookup"><span data-stu-id="adbd6-168">For a list of permissions, see [Security permissions](permissions-reference.md#security-permissions).</span></span>

    ><span data-ttu-id="adbd6-169">**注释：** Microsoft Graph 安全性 API 需要 \*.Read.All scope 才能进行 GET 查询，需要 \*.ReadWrite.All scope 才能进行 PATCH/POST/DELETE 查询。</span><span class="sxs-lookup"><span data-stu-id="adbd6-169">**Note:** The Microsoft Graph Security API requires the \*.Read.All scope for GET queries, and the \*.ReadWrite.All scope for PATCH/POST/DELETE queries.</span></span>

    |<span data-ttu-id="adbd6-170">权限</span><span class="sxs-lookup"><span data-stu-id="adbd6-170">Permission</span></span> | <span data-ttu-id="adbd6-171">实体</span><span class="sxs-lookup"><span data-stu-id="adbd6-171">Entity</span></span> | <span data-ttu-id="adbd6-172">受支持的请求</span><span class="sxs-lookup"><span data-stu-id="adbd6-172">Supported requests</span></span> |
    |:----------|:-------|:-------------------|
    |<span data-ttu-id="adbd6-173">SecurityActions.Read.All</span><span class="sxs-lookup"><span data-stu-id="adbd6-173">SecurityActions.Read.All</span></span>| <span data-ttu-id="adbd6-174">&bull; [securityActions](/graph/api/resources/securityaction?view=graph-rest-beta)（预览）</span><span class="sxs-lookup"><span data-stu-id="adbd6-174">&bull; [securityActions](/graph/api/resources/securityaction?view=graph-rest-beta) (preview)</span></span> | <span data-ttu-id="adbd6-175">GET</span><span class="sxs-lookup"><span data-stu-id="adbd6-175">GET</span></span> |
    |<span data-ttu-id="adbd6-176">SecurityActions.ReadWrite.All</span><span class="sxs-lookup"><span data-stu-id="adbd6-176">SecurityActions.ReadWrite.All</span></span>| <span data-ttu-id="adbd6-177">&bull; [securityActions](/graph/api/resources/securityaction?view=graph-rest-beta)（预览）</span><span class="sxs-lookup"><span data-stu-id="adbd6-177">&bull; [securityActions](/graph/api/resources/securityaction?view=graph-rest-beta) (preview)</span></span> | <span data-ttu-id="adbd6-178">GET, POST</span><span class="sxs-lookup"><span data-stu-id="adbd6-178">GET, POST</span></span> |
    |<span data-ttu-id="adbd6-179">SecurityEvents.Read.All</span><span class="sxs-lookup"><span data-stu-id="adbd6-179">SecurityEvents.Read.All</span></span> | <span data-ttu-id="adbd6-180">&bull; [alerts](/graph/api/resources/alert?view=graph-rest-1.0)</span><span class="sxs-lookup"><span data-stu-id="adbd6-180">&bull; [alerts](/graph/api/resources/alert?view=graph-rest-1.0)</span></span></br> <span data-ttu-id="adbd6-181">&bull; [secureScores](/graph/api/resources/securescores?view=graph-rest-beta)</span><span class="sxs-lookup"><span data-stu-id="adbd6-181">&bull; [secureScores](/graph/api/resources/securescores?view=graph-rest-beta)</span></span> </br> <span data-ttu-id="adbd6-182">&bull; [secureScoreControlProfiles](/graph/api/resources/securescorecontrolprofiles?view=graph-rest-beta)</span><span class="sxs-lookup"><span data-stu-id="adbd6-182">&bull; [secureScoreControlProfiles](/graph/api/resources/securescorecontrolprofiles?view=graph-rest-beta)</span></span> | <span data-ttu-id="adbd6-183">GET</span><span class="sxs-lookup"><span data-stu-id="adbd6-183">GET</span></span> |
    |<span data-ttu-id="adbd6-184">SecurityEvents.ReadWrite.All</span><span class="sxs-lookup"><span data-stu-id="adbd6-184">SecurityEvents.ReadWrite.All</span></span> | <span data-ttu-id="adbd6-185">&bull; [alerts](/graph/api/resources/alert?view=graph-rest-1.0)</span><span class="sxs-lookup"><span data-stu-id="adbd6-185">&bull; [alerts](/graph/api/resources/alert?view=graph-rest-1.0)</span></span></br> <span data-ttu-id="adbd6-186">&bull; [secureScores](/graph/api/resources/securescores?view=graph-rest-beta)</span><span class="sxs-lookup"><span data-stu-id="adbd6-186">&bull; [secureScores](/graph/api/resources/securescores?view=graph-rest-beta)</span></span> </br> <span data-ttu-id="adbd6-187">&bull; [secureScoreControlProfiles](/graph/api/resources/securescorecontrolprofiles?view=graph-rest-beta)</span><span class="sxs-lookup"><span data-stu-id="adbd6-187">&bull; [secureScoreControlProfiles](/graph/api/resources/securescorecontrolprofiles?view=graph-rest-beta)</span></span> | <span data-ttu-id="adbd6-188">GET, POST, PATCH</span><span class="sxs-lookup"><span data-stu-id="adbd6-188">GET, POST, PATCH</span></span> |
    |<span data-ttu-id="adbd6-189">ThreatIndicators.ReadWrite.OwnedBy</span><span class="sxs-lookup"><span data-stu-id="adbd6-189">ThreatIndicators.ReadWrite.OwnedBy</span></span> | <span data-ttu-id="adbd6-190">&bull; [tiIndicator](/graph/api/resources/tiindicator?view=graph-rest-beta)（预览）</span><span class="sxs-lookup"><span data-stu-id="adbd6-190">&bull; [tiIndicator](/graph/api/resources/tiindicator?view=graph-rest-beta) (preview)</span></span> | <span data-ttu-id="adbd6-191">GET, POST, PATCH, DELETE</span><span class="sxs-lookup"><span data-stu-id="adbd6-191">GET, POST, PATCH, DELETE</span></span>|

7. <span data-ttu-id="adbd6-192">选择“**添加权限**”。</span><span class="sxs-lookup"><span data-stu-id="adbd6-192">Choose **Add permissions**.</span></span>

<span data-ttu-id="adbd6-193">保存以下信息：</span><span class="sxs-lookup"><span data-stu-id="adbd6-193">Save the following information:</span></span>

- <span data-ttu-id="adbd6-194">应用程序（客户端）ID</span><span class="sxs-lookup"><span data-stu-id="adbd6-194">Application (client) ID</span></span>
- <span data-ttu-id="adbd6-195">重定向 URL</span><span class="sxs-lookup"><span data-stu-id="adbd6-195">Redirect URL</span></span>
- <span data-ttu-id="adbd6-196">所需权限列表</span><span class="sxs-lookup"><span data-stu-id="adbd6-196">List of required permissions</span></span>

<span data-ttu-id="adbd6-197">与 Microsoft Graph 安全 API 相比，\* Windows Defender 高级威胁防护 (WDATP) 所需的[用户角色](/windows/security/threat-protection/microsoft-defender-atp/user-roles)更多；因此，只有同时具备 WDATP 和 Microsoft Graph 安全 API 角色的用户才可访问 WDATP 数据。</span><span class="sxs-lookup"><span data-stu-id="adbd6-197">\* Windows Defender Advanced Threat Protection (WDATP) requires additional [user roles](/windows/security/threat-protection/microsoft-defender-atp/user-roles) than what is required by the Microsoft Graph Security API; therefore, only the users in both WDATP and Microsoft Graph Security API roles can have access to the WDATP data.</span></span>  <span data-ttu-id="adbd6-198">仅限应用程序的身份验证不受此约束限制；因此，建议使用仅限应用的身份验证令牌。</span><span class="sxs-lookup"><span data-stu-id="adbd6-198">Application-only authentication is not limited by this; therefore, we recommend that you use an app-only authentication token.</span></span>

<span data-ttu-id="adbd6-199">有关详细信息，请参阅[向 Microsoft 标识平台注册应用](auth-register-app-v2.md)。</span><span class="sxs-lookup"><span data-stu-id="adbd6-199">For more information, see [Register your app with the Microsoft identity platform](auth-register-app-v2.md).</span></span>

## <a name="grant-permissions-to-an-application"></a><span data-ttu-id="adbd6-200">向应用程序授予权限</span><span class="sxs-lookup"><span data-stu-id="adbd6-200">Grant permissions to an application</span></span>

<span data-ttu-id="adbd6-201">应用程序注册仅定义应用程序所需的权限，它并不向应用程序授予这些权限。</span><span class="sxs-lookup"><span data-stu-id="adbd6-201">Application registration only defines which permission the application requires - it does not grant these permissions to the application.</span></span> <span data-ttu-id="adbd6-202">Azure AD 租户管理员必须通过调用管理员许可终结点来显示授予这些权限。</span><span class="sxs-lookup"><span data-stu-id="adbd6-202">An Azure AD tenant administrator must explicitly grant these permissions by making a call to the admin consent endpoint.</span></span> <span data-ttu-id="adbd6-203">如需了解详细信息，请参阅[使用管理员许可终结点](/azure/active-directory/develop/active-directory-v2-scopes#using-the-admin-consent-endpoint)。</span><span class="sxs-lookup"><span data-stu-id="adbd6-203">For details, see [Using the admin consent endpoint](/azure/active-directory/develop/active-directory-v2-scopes#using-the-admin-consent-endpoint).</span></span>

<span data-ttu-id="adbd6-204">如要向应用程序授予权限，将需要：</span><span class="sxs-lookup"><span data-stu-id="adbd6-204">To grant permissions to an application, you'll need:</span></span>

- <span data-ttu-id="adbd6-205">**应用程序 ID** - Azure 应用程序注册门户中的应用程序 ID。</span><span class="sxs-lookup"><span data-stu-id="adbd6-205">**Application ID** - The application ID from the Azure application registration portal.</span></span>
- <span data-ttu-id="adbd6-206">**重定向 URL** - 在 Azure 应用程序注册门户中为身份验证响应设置的字符串。</span><span class="sxs-lookup"><span data-stu-id="adbd6-206">**Redirect URL** - The string you set in the Azure application registration portal for authentication response.</span></span>

<span data-ttu-id="adbd6-207">若要授予权限，请执行下列操作：</span><span class="sxs-lookup"><span data-stu-id="adbd6-207">To grant the permissions:</span></span>

- <span data-ttu-id="adbd6-208">在文本编辑器中，创建以下 URL 字符串：</span><span class="sxs-lookup"><span data-stu-id="adbd6-208">In a text editor, create the following URL string:</span></span>

    `https://login.microsoftonline.com/common/adminconsent?client_id=<Application Id>&state=12345&redirect_uri=<Redirect URL>`

- <span data-ttu-id="adbd6-209">在 web 浏览器中转到此 URL，并以租户管理员身份登录。</span><span class="sxs-lookup"><span data-stu-id="adbd6-209">In a web browser, go to this URL, and sign in as a tenant administrator.</span></span> <span data-ttu-id="adbd6-210">对话框将显示应用程序需要的权限列表，如应用程序注册门户中所指定的。</span><span class="sxs-lookup"><span data-stu-id="adbd6-210">The dialog box shows the list of permission the application requires, as specified in the application registration portal.</span></span> <span data-ttu-id="adbd6-211">选择“**确定**”，以向应用程序授予这些权限。</span><span class="sxs-lookup"><span data-stu-id="adbd6-211">Choose **OK** to grant the application these permissions.</span></span>

> <span data-ttu-id="adbd6-212">**注意：** 此步骤向应用程序授予权限，而不是向用户授权。</span><span class="sxs-lookup"><span data-stu-id="adbd6-212">**Note:** This step grants permissions to the application - not to users.</span></span> <span data-ttu-id="adbd6-213">这意味着属于 Azure AD 租户的所有使用此应用程序的用户将被授予权限，甚至包括非管理员用户。</span><span class="sxs-lookup"><span data-stu-id="adbd6-213">This means that all users belonging to the Azure AD tenant that use this application will be granted these permissions - even non-admin users.</span></span>

## <a name="assign-azure-ad-roles-to-users"></a><span data-ttu-id="adbd6-214">向用户分配 Azure AD 角色</span><span class="sxs-lookup"><span data-stu-id="adbd6-214">Assign Azure AD roles to users</span></span>

<span data-ttu-id="adbd6-215">应用程序被授予权限后，每个可以访问该应用程序的人（即 Azure AD 租户的成员）都将获得所授予的权限。</span><span class="sxs-lookup"><span data-stu-id="adbd6-215">After an application is granted permissions, everyone with access to the application (that is, members of the Azure AD tenant) receives the granted permissions.</span></span> <span data-ttu-id="adbd6-216">为了进一步保护敏感安全数据，Microsoft Graph 安全性 API 还要求必须为用户分配 Azure AD **安全读者**角色。</span><span class="sxs-lookup"><span data-stu-id="adbd6-216">To further protect sensitive security data, the Microsoft Graph Security API also requires users to be assigned the Azure AD **Security Reader** role.</span></span> <span data-ttu-id="adbd6-217">有关详细信息，请参阅 [Azure Active Directory 中的管理员角色权限](/azure/active-directory/active-directory-assign-admin-roles-azure-portal)和 [为具有 Azure Active Directory 的用户分配管理员和非管理员角色](/azure/active-directory/active-directory-users-assign-role-azure-portal)。</span><span class="sxs-lookup"><span data-stu-id="adbd6-217">For details, see [Administrator role permissions in Azure Active Directory](/azure/active-directory/active-directory-assign-admin-roles-azure-portal) and [Assign administrator and non-administrator roles to users with Azure Active Directory](/azure/active-directory/active-directory-users-assign-role-azure-portal).</span></span>

><span data-ttu-id="adbd6-218">**注意：** 必须是租户管理员才能执行此步骤。</span><span class="sxs-lookup"><span data-stu-id="adbd6-218">**Note:** You must be a tenant admin to perform this step.</span></span>

<span data-ttu-id="adbd6-219">向用户分配角色：</span><span class="sxs-lookup"><span data-stu-id="adbd6-219">To assign a role to a user:</span></span>

1. <span data-ttu-id="adbd6-220">登录到 [Azure 门户](https://portal.azure.com) (https://portal.azure.com)。</span><span class="sxs-lookup"><span data-stu-id="adbd6-220">Sign in to the [Azure portal](https://portal.azure.com) (https://portal.azure.com).</span></span>
2. <span data-ttu-id="adbd6-221">单击左上角的图标以展开 Azure 门户菜单。</span><span class="sxs-lookup"><span data-stu-id="adbd6-221">Click the icon in the top left to expand the Azure portal menu.</span></span> <span data-ttu-id="adbd6-222">选择“**Azure Active Directory**” > “**用户**”。</span><span class="sxs-lookup"><span data-stu-id="adbd6-222">Select **Azure Active Directory** > **Users**.</span></span>
3. <span data-ttu-id="adbd6-223">单击相应用户的姓名。</span><span class="sxs-lookup"><span data-stu-id="adbd6-223">Click the name of the user.</span></span>
4. <span data-ttu-id="adbd6-224">选择“**分配的角色**”，然后选择“**添加分配**”。</span><span class="sxs-lookup"><span data-stu-id="adbd6-224">Choose **Assigned roles**, and then **Add assignment**.</span></span>
5. <span data-ttu-id="adbd6-225">选择“**安全读取者**”，然后单击“**添加**”。</span><span class="sxs-lookup"><span data-stu-id="adbd6-225">Select **Security reader**, and click **Add**.</span></span>

## <a name="create-an-authentication-code"></a><span data-ttu-id="adbd6-226">创建身份验证代码</span><span class="sxs-lookup"><span data-stu-id="adbd6-226">Create an authentication code</span></span>

<span data-ttu-id="adbd6-227">若要创建身份验证代码，将需要：</span><span class="sxs-lookup"><span data-stu-id="adbd6-227">To create an authentication code, you'll need:</span></span>

- <span data-ttu-id="adbd6-228">**应用程序 ID** - 应用程序注册门户中的应用程序 ID。</span><span class="sxs-lookup"><span data-stu-id="adbd6-228">**Application ID** - The application ID from application registration portal.</span></span>
- <span data-ttu-id="adbd6-229">**重定向 URL** - 该 URL 发送来自 Azure AD 的身份验证响应。</span><span class="sxs-lookup"><span data-stu-id="adbd6-229">**Redirect URL** - The URL where the authentication response from Azure AD is sent.</span></span> <span data-ttu-id="adbd6-230">请使用 https://localhost 或测试客户端 web 应用主页以开始。</span><span class="sxs-lookup"><span data-stu-id="adbd6-230">To start, you can use https://localhost or the test client web app homepage.</span></span>
- <span data-ttu-id="adbd6-231">**应用程序密钥**（可选）- 应用程序的密钥。</span><span class="sxs-lookup"><span data-stu-id="adbd6-231">**Application Key** (optional) - The key of the application.</span></span> <span data-ttu-id="adbd6-232">这适用于将使用仅应用程序身份验证代码（即不支持用户委派身份验证）的应用程序的开发。</span><span class="sxs-lookup"><span data-stu-id="adbd6-232">This applies when you're developing an application that will use application-only authentication code (that is, will not support user delegated authentication).</span></span>

<span data-ttu-id="adbd6-233">下表列出了可用于创建身份验证代码的资源。</span><span class="sxs-lookup"><span data-stu-id="adbd6-233">The following table lists resources that you can use to create an authentication code.</span></span>

|<span data-ttu-id="adbd6-234">**应用程序类型**</span><span class="sxs-lookup"><span data-stu-id="adbd6-234">**Type of application**</span></span>|<span data-ttu-id="adbd6-235">**身份验证库**</span><span class="sxs-lookup"><span data-stu-id="adbd6-235">**Authentication library**</span></span>|
|------------------------|----------------------------|
|[<span data-ttu-id="adbd6-236">桌面应用 - iOS</span><span class="sxs-lookup"><span data-stu-id="adbd6-236">Desktop apps - iOS</span></span>](/azure/active-directory/develop/guidedsetups/active-directory-ios)|[<span data-ttu-id="adbd6-237">MSAL.framework：适用于 iOS 的 Microsoft 身份验证库预览版</span><span class="sxs-lookup"><span data-stu-id="adbd6-237">MSAL.framework: Microsoft Authentication Library Preview for iOS</span></span>](https://github.com/AzureAD/microsoft-authentication-library-for-objc)|
|[<span data-ttu-id="adbd6-238">桌面应用 - Android</span><span class="sxs-lookup"><span data-stu-id="adbd6-238">Desktop apps - Android</span></span>](/azure/active-directory/develop/guidedsetups/active-directory-android)|[<span data-ttu-id="adbd6-239">Microsoft 身份验证库 (MSAL)</span><span class="sxs-lookup"><span data-stu-id="adbd6-239">Microsoft Authentication Library (MSAL)</span></span>](https://javadoc.io/doc/com.microsoft.identity.client/msal)|
|[<span data-ttu-id="adbd6-240">桌面应用 - .Net</span><span class="sxs-lookup"><span data-stu-id="adbd6-240">Desktop apps - .Net</span></span>](/azure/active-directory/develop/guidedsetups/active-directory-windesktop)|[<span data-ttu-id="adbd6-241">Microsoft 身份验证库 (MSAL)</span><span class="sxs-lookup"><span data-stu-id="adbd6-241">Microsoft Authentication Library (MSAL)</span></span>](https://www.nuget.org/packages/Microsoft.Identity.Client)|
|[<span data-ttu-id="adbd6-242">Web 应用 - JavaScript SPA</span><span class="sxs-lookup"><span data-stu-id="adbd6-242">Web apps - JavaScript SPA</span></span>](/azure/active-directory/develop/guidedsetups/active-directory-javascriptspa)|[<span data-ttu-id="adbd6-243">适用于 JavaScript 的 Microsoft 身份验证库预览版</span><span class="sxs-lookup"><span data-stu-id="adbd6-243">Microsoft Authentication Library for JavaScript Preview</span></span>](https://github.com/AzureAD/microsoft-authentication-library-for-js)|
|[<span data-ttu-id="adbd6-244">Web 应用 - .NET Web 服务器</span><span class="sxs-lookup"><span data-stu-id="adbd6-244">Web apps - .NET Web Server</span></span>](/azure/active-directory/develop/guidedsetups/active-directory-aspnetwebapp)|<span data-ttu-id="adbd6-245">OpenIdConnection、Cookie、SystemWeb</span><span class="sxs-lookup"><span data-stu-id="adbd6-245">OpenIdConnection, Cookies, SystemWeb</span></span>|
|[<span data-ttu-id="adbd6-246">Web 应用 - NodeJS Web 应用</span><span class="sxs-lookup"><span data-stu-id="adbd6-246">Web apps - NodeJS Web App</span></span>](/azure/active-directory/develop/active-directory-v2-devquickstarts-node-web)||

<span data-ttu-id="adbd6-247">对于不使用任何现有库的应用程序，请参阅[代表用户获取访问权限](auth-v2-user.md)。</span><span class="sxs-lookup"><span data-stu-id="adbd6-247">For applications that don't use any of the existing libraries, see [Get access on behalf of a user](auth-v2-user.md).</span></span>

1. <span data-ttu-id="adbd6-248">从 Azure AD 获取代码。</span><span class="sxs-lookup"><span data-stu-id="adbd6-248">Get a code from Azure AD.</span></span> <span data-ttu-id="adbd6-249">调用的查询包含应用程序 ID 参数、重定向 URl 和**所需的权限**。</span><span class="sxs-lookup"><span data-stu-id="adbd6-249">The query to call contains parameter for Application ID, Redirect URl, and **required permissions**.</span></span>
2. <span data-ttu-id="adbd6-250">使用代码获取访问令牌。</span><span class="sxs-lookup"><span data-stu-id="adbd6-250">Use the code to get an access token.</span></span>

<span data-ttu-id="adbd6-251">如果你使用 OpenId Connect 库，请参阅[使用 Azure AD 和 OpenID Connect 进行身份验证](/azure/architecture/multitenant-identity/authenticate)并调用 `app.UseOpenIdConnectAuthentication()`。</span><span class="sxs-lookup"><span data-stu-id="adbd6-251">If you use OpenId Connect library, see [Authenticate using Azure AD and OpenID Connect](/azure/architecture/multitenant-identity/authenticate) and call `app.UseOpenIdConnectAuthentication()`.</span></span>

><span data-ttu-id="adbd6-252">**注意：** 如果请求的是用户委派身份验证令牌，库的参数是**请求的作用域**。</span><span class="sxs-lookup"><span data-stu-id="adbd6-252">**Note:** If you're requesting user delegated authentication tokens, the parameter for the library is **Requested Scopes**.</span></span> <span data-ttu-id="adbd6-253">请对该参数使用 User.Read，而非注册的应用程序所要求的值。</span><span class="sxs-lookup"><span data-stu-id="adbd6-253">Use User.Read for this parameter instead of what the registered application requires.</span></span> <span data-ttu-id="adbd6-254">**请求的作用域**参数不影响包含在返回身份验证令牌中的权限。</span><span class="sxs-lookup"><span data-stu-id="adbd6-254">The **Requested Scopes** parameter does NOT affect the permissions contained in the returned authentication tokens.</span></span> <span data-ttu-id="adbd6-255">这些由租户管理员授予应用程序的权限所确定。</span><span class="sxs-lookup"><span data-stu-id="adbd6-255">These are determined by the permissions that the tenant admin granted the application.</span></span>

<span data-ttu-id="adbd6-256">例如，如果使用 .NET MSAL 库，请执行以下调用：</span><span class="sxs-lookup"><span data-stu-id="adbd6-256">For example, if you're using the .NET MSAL library, call the following:</span></span>

`var accessToken = (await client.AcquireTokenAsync(scopes)).AccessToken;`

><span data-ttu-id="adbd6-257">**注意：** 此示例应使用最低的许可权限，如 User.Read。</span><span class="sxs-lookup"><span data-stu-id="adbd6-257">**Note:** This example should use the least privileged permission, such as User.Read.</span></span> <span data-ttu-id="adbd6-258">但是，返回的访问令牌可包含由租户管理员授予当前用户租户的权限，如 User.Read.All 或 User.ReadWrite.All。</span><span class="sxs-lookup"><span data-stu-id="adbd6-258">However, the returned access token can contain permissions that were granted by the tenant admin for the current user tenant, such as User.Read.All or User.ReadWrite.All.</span></span>

<span data-ttu-id="adbd6-259">Azure AD 返回的令牌（字符串）包含身份验证信息和应用程序所需的权限。</span><span class="sxs-lookup"><span data-stu-id="adbd6-259">A token (string) is returned by Azure AD that contains your authentication information and the permissions required by the application.</span></span> <span data-ttu-id="adbd6-260">将此令牌作为持有者令牌分配到 HTTP 标头，如下例所示。</span><span class="sxs-lookup"><span data-stu-id="adbd6-260">Assign this token to the HTTP header as a bearer token, as shown in the following example.</span></span>

`request.Headers.Authorization = new AuthenticationHeaderValue("bearer", accessToken);`

<span data-ttu-id="adbd6-261">Microsoft Graph 将验证包含在此令牌中的信息，并授予或拒绝访问权限。</span><span class="sxs-lookup"><span data-stu-id="adbd6-261">Microsoft Graph will validate the information contained in this token and grant, or reject, access.</span></span>

<span data-ttu-id="adbd6-262">如要查看包含在返回令牌中的声明，请使用 NuGet 库 System.IdentityModel.Tokens.Jwt。</span><span class="sxs-lookup"><span data-stu-id="adbd6-262">To view claims contained in the returned token, use NuGet library System.IdentityModel.Tokens.Jwt.</span></span>

`JwtSecurityTokenHandler tokenHandler = new JwtSecurityTokenHandler();`</br>
`var securityToken = tokenHandler.ReadToken(accessToken) as JwtSecurityToken;`

<span data-ttu-id="adbd6-263">来自 Microsoft Graph 的响应包含一个被称为 client-request-id 的标头，这是一个 GUID。</span><span class="sxs-lookup"><span data-stu-id="adbd6-263">The response from Microsoft Graph contains a header called client-request-id, which is a GUID.</span></span> <span data-ttu-id="adbd6-264">如果访问被拒绝，在 [Microsoft 技术社区](https://techcommunity.microsoft.com/t5/Microsoft-Graph-Security-API/ct-p/SecurityGraphAPI)寻求支持时请指明此 GUID，以便帮助调查此身份验证故障的原因。</span><span class="sxs-lookup"><span data-stu-id="adbd6-264">If access is denied, please specify this GUID when seeking support at [Microsoft Tech Community](https://techcommunity.microsoft.com/t5/Microsoft-Graph-Security-API/ct-p/SecurityGraphAPI), so we can help investigate the cause of this authentication failure.</span></span>