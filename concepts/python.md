# <a name="get-started-with-microsoft-graph-in-a-python-app"></a><span data-ttu-id="f5b31-101">在 Python 应用中开始使用 Microsoft Graph</span><span class="sxs-lookup"><span data-stu-id="f5b31-101">Get started with Microsoft Graph in a Python app</span></span> 

<span data-ttu-id="f5b31-102">本文介绍了从 Azure AD 获取访问令牌和调用 Microsoft Graph 所需的任务。</span><span class="sxs-lookup"><span data-stu-id="f5b31-102">This article describes the tasks required to get an access token from the v2.0 authentication endpoint and call  Microsoft Graph.</span></span> <span data-ttu-id="f5b31-103">本文逐步演示了如何[使用 Python 通过 Microsoft Graph 发送邮件](https://github.com/microsoftgraph/python-sample-send-mail)，并说明了使用 Microsoft Graph API 要实现的主要概念。</span><span class="sxs-lookup"><span data-stu-id="f5b31-103">It walks you through [Sending mail via Microsoft Graph from Python](https://github.com/microsoftgraph/python-sample-send-mail) and explains the main concepts that you implement to use the Microsoft Graph API.</span></span> <span data-ttu-id="f5b31-104">本文介绍了如何使用 REST 直接调用来访问 Microsoft Graph。</span><span class="sxs-lookup"><span data-stu-id="f5b31-104">The article also describes how to access Microsoft Graph by using REST calls.</span></span>

![发送邮件表单](https://raw.githubusercontent.com/microsoftgraph/python-sample-send-mail/master/static/images/sendmail.png)

## <a name="choosing-an-authentication-library"></a><span data-ttu-id="f5b31-106">选择身份验证库</span><span class="sxs-lookup"><span data-stu-id="f5b31-106">Choosing an authentication library</span></span>

<span data-ttu-id="f5b31-107">若要调用 Microsoft Graph，应用必须包含从 Microsoft 云标识服务 Azure Active Directory (Azure AD) 获取的有效访问令牌，且每次调用 Microsoft Graph REST API 时，必须在 HTTP 头中传递令牌。</span><span class="sxs-lookup"><span data-stu-id="f5b31-107">To make calls to Microsoft Graph, your app must obtain a valid access token from Azure Active Directory (Azure AD), the Microsoft cloud identity service, and the token must be passed in an HTTP header with each call to the Microsoft Graph REST API.</span></span> <span data-ttu-id="f5b31-108">Graph 采用的身份验证方法以 OAuth 2.0 和 Open ID Connect 标准为依据。因此，为了在应用中实现身份验证，有许多[身份验证库](https://docs.microsoft.com/zh-CN/azure/active-directory/develop/active-directory-v2-libraries)可供选择。</span><span class="sxs-lookup"><span data-stu-id="f5b31-108">Graph's approach to authentication is based on the OAuth 2.0 and Open ID Connect standards, so there are many [authentication libraries](https://docs.microsoft.com/zh-CN/azure/active-directory/develop/active-directory-v2-libraries) that you can choose from to implement authentication in your application.</span></span>

<span data-ttu-id="f5b31-109">下述示例使用 [Flask-OAuthlib](https://flask-oauthlib.readthedocs.io/en/latest/) 库来实现 OAuth 2.0 [授权代码授权](https://tools.ietf.org/html/rfc6749#section-4.1)工作流，这是适合使用 Python 编写的 Web 应用的推荐身份验证工作流。</span><span class="sxs-lookup"><span data-stu-id="f5b31-109">The sample covered below uses the [Flask-OAuthlib](https://flask-oauthlib.readthedocs.io/en/latest/) library to implement OAuth 2.0 [Authorization Code Grant](https://tools.ietf.org/html/rfc6749#section-4.1) workflow, which is the recommended auth workflow for web applications written in Python.</span></span> <span data-ttu-id="f5b31-110">若要了解其他身份验证选项，请参阅 [Microsoft Graph 的 Python 身份验证示例](https://github.com/microsoftgraph/python-sample-auth)。</span><span class="sxs-lookup"><span data-stu-id="f5b31-110">For information about other authentication options, see [Python authentication samples for Microsoft Graph](https://github.com/microsoftgraph/python-sample-auth).</span></span>

## <a name="installing-and-running-the-send-mail-sample"></a><span data-ttu-id="f5b31-111">安装和运行“发送邮件”示例</span><span class="sxs-lookup"><span data-stu-id="f5b31-111">Installing and running the send-mail sample</span></span>

<span data-ttu-id="f5b31-112">若要安装和配置示例应用，请按照[安装 Python REST 示例](https://github.com/microsoftgraph/python-sample-auth/blob/master/installation.md)中的说明操作。</span><span class="sxs-lookup"><span data-stu-id="f5b31-112">To install and configure the sample app, follow the instructions in [Installing the Python REST samples](https://github.com/microsoftgraph/python-sample-auth/blob/master/installation.md).</span></span> <span data-ttu-id="f5b31-113">对于下述“发送邮件”示例，使用以下命令克隆存储库：</span><span class="sxs-lookup"><span data-stu-id="f5b31-113">For the send-mail sample covered below, use this command to clone the repo:</span></span>

    ```git clone https://github.com/microsoftgraph/python-sample-send-mail.git```

<span data-ttu-id="f5b31-114">按照[安装说明](https://github.com/microsoftgraph/python-sample-auth/blob/master/installation.md)中所述注册应用时，请务必添加 **User.Read** 和 **Mail.Send** 权限，这些是此示例的必需权限。</span><span class="sxs-lookup"><span data-stu-id="f5b31-114">When you register the application as covered in the [installation instructions](https://github.com/microsoftgraph/python-sample-auth/blob/master/installation.md), be sure to include the **User.Read** and **Mail.Send** permissions, which are required for this sample.</span></span>

<span data-ttu-id="f5b31-115">完成安装/配置后，可以按照[运行示例](https://github.com/microsoftgraph/python-sample-send-mail#running-the-sample)中的说明操作，运行示例应用。</span><span class="sxs-lookup"><span data-stu-id="f5b31-115">After completing the installation/configuration, you can run the sample app by following the instructions for [running the sample](https://github.com/microsoftgraph/python-sample-send-mail#running-the-sample).</span></span>

## <a name="code-walkthrough"></a><span data-ttu-id="f5b31-116">代码演练</span><span class="sxs-lookup"><span data-stu-id="f5b31-116">Code walkthrough</span></span>

<span data-ttu-id="f5b31-117">下面大致介绍了示例应用的[源代码](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py)。</span><span class="sxs-lookup"><span data-stu-id="f5b31-117">The following is an overview of the [source code](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py) for the sample app.</span></span>

<span data-ttu-id="f5b31-118">前几行代码是此示例中使用的 Python 模块和包的[导入](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L4-L11)部分：</span><span class="sxs-lookup"><span data-stu-id="f5b31-118">The first few lines of code are the [imports](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L4-L11) for the Python modules and packages used in the sample:</span></span>

* <span data-ttu-id="f5b31-119">标准库中的 **base64** 模块用于编码电子邮件附件。</span><span class="sxs-lookup"><span data-stu-id="f5b31-119">The **base64** module from the standard library is used for encoding email attachments.</span></span>
* <span data-ttu-id="f5b31-120">标准库中的 **pprint** 模块用于优质打印 Graph 返回的任何错误消息。</span><span class="sxs-lookup"><span data-stu-id="f5b31-120">The **pprint** module from the standard library is used to pretty-print any error messages returned by Graph.</span></span> <span data-ttu-id="f5b31-121">（例如，如果尝试发送到的电子邮件地址无效。）</span><span class="sxs-lookup"><span data-stu-id="f5b31-121">(For example, if you try to send to an invalid email address.)</span></span>
* <span data-ttu-id="f5b31-122">标准库中的 **uuid** 模块用于生成包含 36 个字符的随机字符串，以唯一标识每个 Graph 请求。</span><span class="sxs-lookup"><span data-stu-id="f5b31-122">The **uuid** module from the standard library is used to generate a random 36-character string to uniquely identify each Graph request.</span></span> <span data-ttu-id="f5b31-123">这可用于进行调试。</span><span class="sxs-lookup"><span data-stu-id="f5b31-123">This can be useful for debugging purposes.</span></span>
* <span data-ttu-id="f5b31-124">**flask** 包是此示例的 Web 框架。</span><span class="sxs-lookup"><span data-stu-id="f5b31-124">The **flask** package is the web framework for the sample.</span></span>
* <span data-ttu-id="f5b31-125">**flask_oauthlib.client** 的 **OAuth** 类是 Flask 应用的包装器，用于实现 OAuth 2.0 身份验证工作流。</span><span class="sxs-lookup"><span data-stu-id="f5b31-125">The **OAuth** class of **flask_oauthlib.client** is a wrapper around the Flask app that implements the OAuth 2.0 authentication workflow.</span></span>
* <span data-ttu-id="f5b31-126">**config** 模块包含上面安装过程中配置的应用注册设置。</span><span class="sxs-lookup"><span data-stu-id="f5b31-126">The **config** module contains the application registration settings, as configured in the installation process above.</span></span>

<span data-ttu-id="f5b31-127">接下来，先[创建 Flask 应用](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L13-L15)，再创建名为 **MSGRAPH** 的 [Graph 客户端对象](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L17-L26)。</span><span class="sxs-lookup"><span data-stu-id="f5b31-127">Next, we [create a Flask app](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L13-L15) and then create the [Graph client object](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L17-L26), named **MSGRAPH**.</span></span>

<span data-ttu-id="f5b31-128">完成初始设置步骤后，将处理下列三个实现身份验证工作流的 Flask 路由处理程序函数：[homepage()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L28-L31)、[login()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L33-L37) 和 [authorized()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L39-L46)。</span><span class="sxs-lookup"><span data-stu-id="f5b31-128">After those initial setup steps come three Flask route handler functions that implement the authentication workflow: [homepage()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L28-L31), [login()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L33-L37), and [authorized()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L39-L46).</span></span> <span data-ttu-id="f5b31-129">若要详细了解身份验证工作流，请参阅 Python 身份验证示例存储库的[示例体系结构](https://github.com/microsoftgraph/python-sample-auth#sample-architecture)部分。</span><span class="sxs-lookup"><span data-stu-id="f5b31-129">For more information about the authentication workflow, see the [Sample architecture](https://github.com/microsoftgraph/python-sample-auth#sample-architecture) section of the Python authentication samples repo.</span></span>

<span data-ttu-id="f5b31-130">下一个路由处理程序 [mailform()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L48-L54) 是指定电子邮件收件人、主题和正文的表单。</span><span class="sxs-lookup"><span data-stu-id="f5b31-130">The next route handler, [mailform()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L48-L54), is the form where you specify email recipients, subject, and body.</span></span> <span data-ttu-id="f5b31-131">请注意，此函数也负责首次调用 Graph：[检索用户配置文件](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L51-L51)，以获取当前用户的显示名称和电子邮件地址，这些信息将被[传递到 mailform.html 模板](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L52-L54)。</span><span class="sxs-lookup"><span data-stu-id="f5b31-131">Note that this function also includes our first call to Graph: [retrieving the user profile](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L51-L51) to get the current user's display name and email address, which are [passed to the mailform.html template](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L52-L54).</span></span>

<span data-ttu-id="f5b31-132">下一个 [send_mail()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L56-L73) 函数发送电子邮件，并显示 Graph API 返回的响应。</span><span class="sxs-lookup"><span data-stu-id="f5b31-132">Next is the [send_mail()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L56-L73) function, which sends the email and displays the response from the Graph API.</span></span> <span data-ttu-id="f5b31-133">它使用 sendmail() 帮助程序函数，同时向它传递从表单公布的查询字符串参数：</span><span class="sxs-lookup"><span data-stu-id="f5b31-133">It uses a sendmail() helper function, passing to it the query string parameters that were posted from the form:</span></span>

```python
response = sendmail(MSGRAPH,
                    subject=flask.request.args['subject'],
                    recipients=flask.request.args['email'].split(';'),
                    html=flask.request.args['body'])
```

<span data-ttu-id="f5b31-134">只要调用 Graph，Flask-OAuthlib 客户端实例 (```MSGRAPH```) 都是使用 [get_token()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L75-L78) 函数来获取访问令牌。</span><span class="sxs-lookup"><span data-stu-id="f5b31-134">The [get_token()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L75-L78) function is used by the Flask-OAuthlib client instance (```MSGRAPH```) to obtain an access token whenever we make calls to Graph.</span></span> <span data-ttu-id="f5b31-135">虽然访问令牌在名为 **Authorization** 的 HTTP 头中传递，但无需在代码中对此进行处理。</span><span class="sxs-lookup"><span data-stu-id="f5b31-135">The access token is passed in an HTTP header named **Authorization**, but you don't need to deal with this in your code.</span></span> <span data-ttu-id="f5b31-136">只需通过客户端的 HTTP 谓词方法（例如，get() 或 post()）调用 Graph，客户端实例就会知道调用 ```get_token()``` 来获取令牌，因为此函数是使用 ```tokengetter``` 进行[修饰](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L75-L75)。</span><span class="sxs-lookup"><span data-stu-id="f5b31-136">You can simply make calls to Graph via the client's HTTP verb methods (for example, get() or post()), and the client instance will know to call ```get_token()``` to obtain a token, because the function is [decorated](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L75-L75) with ```tokengetter```.</span></span>

<span data-ttu-id="f5b31-137">下一个 [request_headers()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L80-L85) 函数返回随每次 Graph 调用一起发送的 HTTP 头的字典。</span><span class="sxs-lookup"><span data-stu-id="f5b31-137">Next comes [request_headers()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L80-L85), which returns a dictionary of HTTP headers that are sent with each call to Graph.</span></span>

<span data-ttu-id="f5b31-138">最后一个 [sendmail()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L87-L129) 是用于发送电子邮件的帮助程序函数。</span><span class="sxs-lookup"><span data-stu-id="f5b31-138">Finally we have [sendmail()](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L87-L129), the helper function for sending email.</span></span> <span data-ttu-id="f5b31-139">它使用 Microsoft Graph API 中的 ```me/microsoft.graph.sendMail``` 终结点发送邮件。无论何时需要通过 Microsoft Graph 发送电子邮件，都可以在自己的代码中重用此函数。</span><span class="sxs-lookup"><span data-stu-id="f5b31-139">It sends a message using the ```me/microsoft.graph.sendMail``` endpoint in the Microsoft Graph API, and you can re-use this function in your own code whenever you need to send email via Microsoft Graph.</span></span> <span data-ttu-id="f5b31-140">若要了解如何调用此函数，请参阅 [docstring](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L88-L97)。</span><span class="sxs-lookup"><span data-stu-id="f5b31-140">See the [docstring](https://github.com/microsoftgraph/python-sample-send-mail/blob/master/sample.py#L88-L97) for information about how to call this function.</span></span>

## <a name="other-python-rest-samples"></a><span data-ttu-id="f5b31-141">其他 Python REST 示例</span><span class="sxs-lookup"><span data-stu-id="f5b31-141">Other Python REST samples</span></span>

<span data-ttu-id="f5b31-142">除了上述示例外，下面的示例展示了如何通过 Python 使用 Microsoft Graph 的其他功能：</span><span class="sxs-lookup"><span data-stu-id="f5b31-142">In addition to the sample covered above, the following samples demonstrate how to work with other features of Microsoft Graph from Python:</span></span>

* [<span data-ttu-id="f5b31-143">Microsoft Graph 的 Python 身份验证示例</span><span class="sxs-lookup"><span data-stu-id="f5b31-143">Python authentication samples for Microsoft Graph</span></span>](https://github.com/microsoftgraph/python-sample-auth)
* [<span data-ttu-id="f5b31-144">在 Python 中处理分页 Microsoft Graph 响应</span><span class="sxs-lookup"><span data-stu-id="f5b31-144">Working with paginated Microsoft Graph responses in Python</span></span>](https://github.com/microsoftgraph/python-sample-pagination)
* [<span data-ttu-id="f5b31-145">在 Python 中使用 Graph 开放扩展</span><span class="sxs-lookup"><span data-stu-id="f5b31-145">Working with Graph open extensions in Python</span></span>](https://github.com/microsoftgraph/python-sample-open-extensions)

<span data-ttu-id="f5b31-146">若要查看某个特定示例，请通过[提交问题](https://github.com/microsoftgraph/python-sample-auth/issues)告诉我们。</span><span class="sxs-lookup"><span data-stu-id="f5b31-146">If there's a particular sample you'd like to see, please let us know by [submitting an issue](https://github.com/microsoftgraph/python-sample-auth/issues).</span></span> <span data-ttu-id="f5b31-147">我们非常期待收到大家就希望在 Python 中生成的任何 Microsoft Graph 方案提供的反馈。</span><span class="sxs-lookup"><span data-stu-id="f5b31-147">We're very interested in your feedback on any Microsoft Graph scenario you'd like to build in Python!</span></span>

<span data-ttu-id="f5b31-148">Microsoft Graph API 的功能非常强大，统一了可用于与各种 Microsoft 数据进行交互的 API。</span><span class="sxs-lookup"><span data-stu-id="f5b31-148">The Microsoft Graph API is a very powerful, unifiying API that can be used to interact with all kinds of Microsoft data. Check out the API reference to explore what else you can accomplish with Microsoft Graph.</span></span> <span data-ttu-id="f5b31-149">请查看[开发人员文档](https://developer.microsoft.com/zh-CN/graph/docs/concepts/overview)或 [Graph 浏览器](https://developer.microsoft.com/zh-CN/graph/graph-explorer)，了解还可以使用 Microsoft Graph 做什么。</span><span class="sxs-lookup"><span data-stu-id="f5b31-149">Check out the [developer documentation](https://developer.microsoft.com/zh-CN/graph/docs/concepts/overview) or the [Graph Explorer](https://developer.microsoft.com/zh-CN/graph/graph-explorer) to explore what else you can accomplish with Microsoft Graph.</span></span>
