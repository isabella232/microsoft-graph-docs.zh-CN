#  <a name="use-delta-query-to-track-changes-in-microsoft-graph-data"></a><span data-ttu-id="e3402-101">使用增量查询跟踪 Microsoft Graph 数据更改</span><span class="sxs-lookup"><span data-stu-id="e3402-101">Use delta query to track changes in Microsoft Graph data</span></span>

<span data-ttu-id="e3402-p101">Delta 查询使应用程序能够发现新创建、更新或删除的实体，无需使用每个请求对目标资源执行完全读取。Microsoft Graph 应用程序可以使用 delta 查询和本地数据存储高效地同步更改。</span><span class="sxs-lookup"><span data-stu-id="e3402-p101">Delta query enables applications to discover newly created, updated, or deleted entities without performing a full read of the target resource with every request. Microsoft Graph applications can use delta query to efficiently synchronize changes with a local data store.</span></span>

## <a name="use-delta-query-to-track-changes-in-a-resource-collection"></a><span data-ttu-id="e3402-104">使用 delta 查询来跟踪资源集合的更改</span><span class="sxs-lookup"><span data-stu-id="e3402-104">Use delta query to track changes in a resource collection</span></span>

<span data-ttu-id="e3402-105">通常的调用模式如下：</span><span class="sxs-lookup"><span data-stu-id="e3402-105">The typical call pattern is as follows:</span></span>

1.  <span data-ttu-id="e3402-106">应用程序首先对所需资源运行 delta 函数以调用 GET 请求。</span><span class="sxs-lookup"><span data-stu-id="e3402-106">The application begins by calling a GET request with the delta function on the desired resource.</span></span>
2.  <span data-ttu-id="e3402-107">Microsoft Graph 发送一个包含已请求资源和[状态令牌](#state-tokens)的响应。</span><span class="sxs-lookup"><span data-stu-id="e3402-107">Microsoft Graph sends a response containing the requested resource and a [state token](#state-tokens).</span></span>

     <span data-ttu-id="e3402-p102">a.如果返回了 `nextLink` URL，则会话中可能存在要检索的其他数据页面。应用程序继续使用 `nextLink` URL 发出请求以检索所有页面中的数据，直到响应中返回 `deltaLink` URL。</span><span class="sxs-lookup"><span data-stu-id="e3402-p102">a.  If a `nextLink` URL is returned, there may be additional pages of data to be retrieved in the session. The application continues making requests using the `nextLink` URL to retrieve all pages of data until a `deltaLink` URL is returned in the response.</span></span>

     <span data-ttu-id="e3402-p103">b.如果返回了 `deltaLink` URL，则未返回关于资源现有状态的更多数据。为了执行以后的请求，应用程序使用 `deltaLink` URL 了解资源更改。</span><span class="sxs-lookup"><span data-stu-id="e3402-p103">b.  If a `deltaLink` URL is returned, there is no more data about the existing state of the resource to be returned. For future requests, the application uses the `deltaLink` URL to learn about changes to the resource.</span></span>
     
3.  <span data-ttu-id="e3402-p104">当应用程序需要了解资源更改时，会使用步骤 2 中收到的 `deltaLink` URL 发出新请求。*可能*在完成步骤 2 或应用程序检查更改时立即发出此请求。</span><span class="sxs-lookup"><span data-stu-id="e3402-p104">When the application needs to learn about changes to the resource, it makes a new request using the `deltaLink` URL received in step 2. This request *may* be made immediately after completing step 2 or when the application checks for changes.</span></span>
4.  <span data-ttu-id="e3402-116">Microsoft Graph 返回响应，描述自上一个请求以来的资源更改和 `nextLink` URL 或 `deltaLink` URL。</span><span class="sxs-lookup"><span data-stu-id="e3402-116">Microsoft Graph returns a response describing changes to the resource since the previous request, and either a `nextLink` URL or a `deltaLink` URL.</span></span>

### <a name="state-tokens"></a><span data-ttu-id="e3402-117">状态令牌</span><span class="sxs-lookup"><span data-stu-id="e3402-117">State tokens</span></span>

<span data-ttu-id="e3402-p105">增量查询 GET 响应中始终返回 `nextLink` 或 `deltaLink` 响应头中指定的 URL。`nextLink` URL 包含的是 _skipToken_，`deltaLink` URL 包含的是 _deltaToken_。</span><span class="sxs-lookup"><span data-stu-id="e3402-p105">A delta query GET response always includes a URL specified in a `nextLink` or `deltaLink` response header. The `nextLink` URL includes a _skipToken_, and a `deltaLink` URL includes a _deltaToken_.</span></span> 

<span data-ttu-id="e3402-p106">这些令牌对客户端不透明。以下是需要了解的详细信息：</span><span class="sxs-lookup"><span data-stu-id="e3402-p106">These tokens are opaque to the client. The following details are what you need to know about them:</span></span>

- <span data-ttu-id="e3402-122">每个令牌都反映状态，并表示一轮更改跟踪中的响应快照。</span><span class="sxs-lookup"><span data-stu-id="e3402-122">Each token reflects the state and represents a snapshot of the resource in that round of change tracking.</span></span> 
- <span data-ttu-id="e3402-p107">状态令牌还会进行编码，并包括初始 delta 查询请求中指定的其他查询参数（如 `$select`）。因此，不需要在后续 delta 查询请求中重复这些操作。</span><span class="sxs-lookup"><span data-stu-id="e3402-p107">The state tokens also encode and include other query parameters (such as `$select`) specified in the initial delta query request. Therefore, it's not required to repeat them in subsequent delta query requests.</span></span>
- <span data-ttu-id="e3402-125">执行增量查询时，可以将 `nextLink` 或 `deltaLink` URL 复制并应用到下一个 **delta** 函数调用，无需检查 URL 的内容（包括其状态令牌）。</span><span class="sxs-lookup"><span data-stu-id="e3402-125">When carrying out delta query, you can copy and apply the `nextLink` or `deltaLink` URL to the next **delta** function call without having to inspect the contents of the URL, including its state token.</span></span>


### <a name="optional-query-parameters"></a><span data-ttu-id="e3402-126">可选的查询参数</span><span class="sxs-lookup"><span data-stu-id="e3402-126">Optional query parameters</span></span>

<span data-ttu-id="e3402-p108">如果客户使用查询参数，则它必须在初始请求中指定。Microsoft Graph 自动将指定参数编码为响应中提供的 `nextLink` 或 `deltaLink`。调用应用程序只需预先指定其所需的查询参数一次。Microsoft Graph 将为所有后续请求自动添加指定参数。</span><span class="sxs-lookup"><span data-stu-id="e3402-p108">If a client uses a query parameter, it must be specified in the initial request. Microsoft Graph automatically encodes the specified parameter into the `nextLink` or `deltaLink` provided in the response. The calling application only needs to specify their desired query parameters once upfront. Microsoft Graph adds the specified parameters automatically for all subsequent requests.</span></span>

<span data-ttu-id="e3402-131">对于用户和组，在使用某些查询参数时受到限制：</span><span class="sxs-lookup"><span data-stu-id="e3402-131">For users and groups, there are restrictions on using some query parameters:</span></span>

-   <span data-ttu-id="e3402-p109">如果使用的是 `$select` 查询参数，则该参数表示客户倾向于仅跟踪 `$select` 语句中指定的属性或关系的更改。如果未选中的属性发生更改，则属性已更改的资源将不会出现在后续请求之后的 delta 响应中。</span><span class="sxs-lookup"><span data-stu-id="e3402-p109">If a `$select` query parameter is used, the parameter indicates that the client prefers to only track changes on the properties or relationships specified in the `$select` statement. If a change occurs to a property that is not selected, the resource for which that property changed does not appear in the delta response after a subsequent request.</span></span>
-   <span data-ttu-id="e3402-134">不支持 `$expand`。</span><span class="sxs-lookup"><span data-stu-id="e3402-134">`$expand` is not supported.</span></span>

<span data-ttu-id="e3402-p110">对于用户和组 beta（预览）API，作用域筛选器允许按 objectId 跟踪对一个或多个特定用户或组所做的更改。例如，下面的请求：https://graph.microsoft.com/beta/groups/delta/?$filter= id eq '477e9fc6-5de7-4406-bb2a-7e5c83c9ae5f' or id eq '004d6a07-fe70-4b92-add5-e6e37b8acd8e' 返回对与在查询筛选器中指定的 id 相匹配的组的更改。</span><span class="sxs-lookup"><span data-stu-id="e3402-p110">For users and groups beta (preview) APIs, scoping filters allow you to track changes to one or more specific users or groups by objectId. For example, the following request: https://graph.microsoft.com/beta/groups/delta/?$filter= id eq '477e9fc6-5de7-4406-bb2a-7e5c83c9ae5f' or id eq '004d6a07-fe70-4b92-add5-e6e37b8acd8e' returns changes for the groups matching the ids specified in the query filter.</span></span> 

## <a name="resource-representation-in-the-delta-query-response"></a><span data-ttu-id="e3402-137">delta 查询响应中的资源表示形式</span><span class="sxs-lookup"><span data-stu-id="e3402-137">Resource representation in the delta query response</span></span>

-   <span data-ttu-id="e3402-138">在 delta 查询响应中，使用标准表示形式表示受支持资源的新建实例。</span><span class="sxs-lookup"><span data-stu-id="e3402-138">Newly created instances of a supported resource are represented in the delta query response using their standard representation.</span></span>

-   <span data-ttu-id="e3402-139">更新实例由它们的 **id** 表示，*至少*具有已更新的属性，但可能也包含其他属性。</span><span class="sxs-lookup"><span data-stu-id="e3402-139">Updated instances are represented by their **id** with *at least* the properties that have been updated, but additional properties may be included.</span></span>

-   <span data-ttu-id="e3402-p111">用户和组的关系表示为对标准资源表示形式的注释。这些注释使用格式 `propertyName@delta`。注释包含在初始 delta 查询请求的响应内。</span><span class="sxs-lookup"><span data-stu-id="e3402-p111">Relationships on users and groups are represented as annotations on the standard resource representation. These annotations use the format `propertyName@delta`. The annotations are included in the response of the initial delta query request.</span></span>

<span data-ttu-id="e3402-p112">删除的实例使用其 **id** 和 `@removed` 对象表示。`@removed` 对象可能包含有关为何删除该实例的其他信息。例如，"@removed": {"reason": “changed”}。</span><span class="sxs-lookup"><span data-stu-id="e3402-p112">Removed instances are represented by their **id** and an `@removed` object. The `@removed` object may include additional information about why the instance was removed. For example,  "@removed": {"reason": “changed”}.</span></span>

<span data-ttu-id="e3402-146">可能的 @removed 原因可以是*已更改*或*已删除*。</span><span class="sxs-lookup"><span data-stu-id="e3402-146">Possible @removed reasons can be *changed* or *deleted*.</span></span>
- <span data-ttu-id="e3402-147">*已更改*表示该项已被删除，可以从 [deletedItems](../api-reference/beta/resources/directory.md) 恢复。</span><span class="sxs-lookup"><span data-stu-id="e3402-147">*Changed* indicates the item was deleted and can be restored from [deletedItems](../api-reference/beta/resources/directory.md).</span></span>
- <span data-ttu-id="e3402-148">*已删除*表示该项已被删除，无法恢复。</span><span class="sxs-lookup"><span data-stu-id="e3402-148">*Deleted* indicates the item is deleted and cannot be restored.</span></span>

<span data-ttu-id="e3402-p113">`@removed` 对象可以在初始 delta 查询响应和跟踪的 (deltaLink) 响应中返回。使用 delta 查询请求的客户端应能够处理响应中的这些对象。</span><span class="sxs-lookup"><span data-stu-id="e3402-p113">@removed object can be returned in the initial delta query response and in tracked (deltaLink) responses. Clients using delta query requests should be designed to handle these object in the responses.</span></span>

## <a name="supported-resources"></a><span data-ttu-id="e3402-151">支持的资源</span><span class="sxs-lookup"><span data-stu-id="e3402-151">Supported resources</span></span>

<span data-ttu-id="e3402-152">目前，以下资源支持 delta 查询。</span><span class="sxs-lookup"><span data-stu-id="e3402-152">Delta query is currently supported for the following resources:</span></span>

| <span data-ttu-id="e3402-153">**资源集合**</span><span class="sxs-lookup"><span data-stu-id="e3402-153">**Resource collection**</span></span> | <span data-ttu-id="e3402-154">**API**</span><span class="sxs-lookup"><span data-stu-id="e3402-154">**API**</span></span> |
|:------ | :------ |
| <span data-ttu-id="e3402-155">主日历的日历视图（日期范围）中的事件</span><span class="sxs-lookup"><span data-stu-id="e3402-155">Events in a calendar view (date range) of the primary calendar</span></span> | <span data-ttu-id="e3402-156">[事件](../api-reference/v1.0/resources/event.md)资源的 [delta](../api-reference/v1.0/api/event_delta.md) 函数</span><span class="sxs-lookup"><span data-stu-id="e3402-156">[delta](../api-reference/v1.0/api/event_delta.md) function of the [event](../api-reference/v1.0/resources/event.md) resource</span></span> |
| <span data-ttu-id="e3402-157">组</span><span class="sxs-lookup"><span data-stu-id="e3402-157">Groups</span></span> | <span data-ttu-id="e3402-158">[组](../api-reference/v1.0/resources/group.md)资源的 [delta](../api-reference/v1.0/api/group_delta.md) 函数</span><span class="sxs-lookup"><span data-stu-id="e3402-158">[delta](../api-reference/v1.0/api/group_delta.md) function of the [group](../api-reference/v1.0/resources/group.md) resource</span></span> |
| <span data-ttu-id="e3402-159">邮件文件夹</span><span class="sxs-lookup"><span data-stu-id="e3402-159">Mail folders</span></span> | <span data-ttu-id="e3402-160">[邮件文件夹](../api-reference/v1.0/resources/mailFolder.md)资源的 [delta](../api-reference/v1.0/api/mailfolder_delta.md) 函数</span><span class="sxs-lookup"><span data-stu-id="e3402-160">[delta](../api-reference/v1.0/api/mailfolder_delta.md) function of the [mailFolder](../api-reference/v1.0/resources/mailFolder.md) resource</span></span> |
| <span data-ttu-id="e3402-161">文件夹中的邮件</span><span class="sxs-lookup"><span data-stu-id="e3402-161">Messages in a folder</span></span> | <span data-ttu-id="e3402-162">[邮件](../api-reference/v1.0/resources/message.md)资源的 [delta](../api-reference/v1.0/api/message_delta.md) 函数</span><span class="sxs-lookup"><span data-stu-id="e3402-162">[delta](../api-reference/v1.0/api/message_delta.md) function of the [message](../api-reference/v1.0/resources/message.md) resource</span></span> | 
| <span data-ttu-id="e3402-163">私人联系人文件夹</span><span class="sxs-lookup"><span data-stu-id="e3402-163">Personal contact folders</span></span> | <span data-ttu-id="e3402-164">[联系人文件夹](../api-reference/v1.0/resources/contactfolder.md)资源的 [delta](../api-reference/v1.0/api/contactfolder_delta.md) 函数</span><span class="sxs-lookup"><span data-stu-id="e3402-164">[delta](../api-reference/v1.0/api/contactfolder_delta.md) function of the [contactFolder](../api-reference/v1.0/resources/contactfolder.md) resource</span></span> |
| <span data-ttu-id="e3402-165">文件夹中的私人联系人</span><span class="sxs-lookup"><span data-stu-id="e3402-165">Personal contacts in a folder</span></span> | <span data-ttu-id="e3402-166">[联系人](../api-reference/v1.0/resources/contact.md)资源的 [delta](../api-reference/v1.0/api/contact_delta.md) 函数</span><span class="sxs-lookup"><span data-stu-id="e3402-166">[delta](../api-reference/v1.0/api/contact_delta.md) function of the [contact](../api-reference/v1.0/resources/contact.md) resource</span></span> |
| <span data-ttu-id="e3402-167">用户</span><span class="sxs-lookup"><span data-stu-id="e3402-167">Users</span></span> | <span data-ttu-id="e3402-168">[用户](../api-reference/v1.0/resources/user.md)资源的 [delta](../api-reference/v1.0/api/user_delta.md) 函数</span><span class="sxs-lookup"><span data-stu-id="e3402-168">[delta](../api-reference/v1.0/api/user_delta.md) function of the [user](../api-reference/v1.0/resources/user.md) resource</span></span> | 
| <span data-ttu-id="e3402-169">驱动器项目\*</span><span class="sxs-lookup"><span data-stu-id="e3402-169">Drive items\*</span></span> | <span data-ttu-id="e3402-170">[driveItem](../api-reference/v1.0/resources/driveitem.md) 资源的 [delta](../api-reference/v1.0/api/driveitem_delta.md) 函数</span><span class="sxs-lookup"><span data-stu-id="e3402-170">[delta](../api-reference/v1.0/api/driveitem_delta.md) function of the [driveItem](../api-reference/v1.0/resources/driveitem.md) resource</span></span> |


> <span data-ttu-id="e3402-p114">\* OneDrive 资源的使用模式与其他支持资源类似，仅存在一些小的语法差异。为了与其他资源类型保持一致，适用于驱动器的 delta 查询今后将进行更新。若要详细了解现行语法，请参阅[跟踪驱动器更改](https://developer.microsoft.com/en-us/graph/docs/api-reference/v1.0/api/item_delta)。</span><span class="sxs-lookup"><span data-stu-id="e3402-p114">\* The usage pattern for OneDrive resources is similar to the other supported resources with some minor syntax differences. Delta query for drives will be updated in the future to be consistent with other resource types. For more detail about the current syntax, please see: [https://developer.microsoft.com/en-us/graph/docs/api-reference/v1.0/api/item_delta](https://developer.microsoft.com/en-us/graph/docs/api-reference/v1.0/api/item_delta)</span></span>

## <a name="prerequisites"></a><span data-ttu-id="e3402-174">先决条件</span><span class="sxs-lookup"><span data-stu-id="e3402-174">Prerequisites</span></span>

<span data-ttu-id="e3402-175">在对某个特定资源执行 delta 查询时也需要读取该资源所需的相同[权限](./permissions_reference.md)。</span><span class="sxs-lookup"><span data-stu-id="e3402-175">The same [permissions](./permissions_reference.md) that are required to read a specific resource are also required to perform delta query on that resource.</span></span>

## <a name="delta-query-request-examples"></a><span data-ttu-id="e3402-176">delta 查询请求示例</span><span class="sxs-lookup"><span data-stu-id="e3402-176">Delta query request examples</span></span> 

- [<span data-ttu-id="e3402-177">获取日历视图中事件的增量更改</span><span class="sxs-lookup"><span data-stu-id="e3402-177">Get incremental changes to events in a calendar view</span></span>](../concepts/delta_query_events.md)
- [<span data-ttu-id="e3402-178">获取文件夹中邮件的增量更改</span><span class="sxs-lookup"><span data-stu-id="e3402-178">Get incremental changes to messages in a folder</span></span>](./delta_query_messages.md)
- [<span data-ttu-id="e3402-179">获取组的增量更改</span><span class="sxs-lookup"><span data-stu-id="e3402-179">Get incremental changes to groups</span></span>](./delta_query_groups.md)
- [<span data-ttu-id="e3402-180">获取用户的增量更改</span><span class="sxs-lookup"><span data-stu-id="e3402-180">Get incremental changes to users</span></span>](./delta_query_users.md)
